<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Availability</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
<div class="container availability-container">
    <h1>Availability</h1>

    <!-- GO BACK TO DASHBOARD -->
    <div class="availability-actions">
        <a th:href="@{|/employees/${employeeId}/dashboard|}"
           class="btn btn-secondary">
            Geri Dön
        </a>
    </div>

    <!-- ERROR MESSAGE -->
    <div id="availability-warning"
         class="availability-warning"
         style="display:none;">
    </div>

    <div id="success-popup" class="availability-success-popup">
        Availability başarıyla kaydedildi. ✔
    </div>


    <form id="availabilityForm" onsubmit="submitAvailability(event)">

        <!-- FINAL SELECTION -->
        <input type="hidden" name="slots" id="slotsInput">

        <div class="availability-layout">

            <!-- WEEK SELECT -->
            <div class="availability-sidebar">
                <button type="button"
                        id="btn-week1"
                        class="btn btn-small active"
                        onclick="showWeek(1)">
                    1. Hafta
                </button>

                <button type="button"
                        id="btn-week2"
                        class="btn btn-small"
                        onclick="showWeek(2)">
                    2. Hafta
                </button>
            </div>

            <!-- TABLES -->
            <div class="availability-table-wrapper">

                <!-- WEEK 1 -->
                <table id="week1-table" class="table availability-table">
                    <thead>
                    <tr>
                        <th>Saat \ Tarih</th>
                        <th th:each="d : ${week1Dates}"
                            th:text="${#temporals.format(d,'EEE dd.MM')}"></th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="hour : ${hours}">
                        <td th:text="${hour + ':00'}"></td>

                        <td th:each="d : ${week1Dates}"
                            th:with="
                                dateStr=${#temporals.format(d,'yyyy-MM-dd')},
                                key=${dateStr + '_' + hour},
                                status=${week1StatusMap.get(key) != null ? week1StatusMap.get(key) : 0}
                            "
                            th:class="'cell status-' + ${status}"
                            th:data-key="${key}"
                            onclick="toggleCell(this)">
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!-- WEEK 2 -->
                <table id="week2-table" class="table availability-table" style="display:none;">
                    <thead>
                    <tr>
                        <th>Saat \ Tarih</th>
                        <th th:each="d : ${week2Dates}"
                            th:text="${#temporals.format(d,'EEE dd.MM')}"></th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="hour : ${hours}">
                        <td th:text="${hour + ':00'}"></td>

                        <td th:each="d : ${week2Dates}"
                            th:with="
                                dateStr=${#temporals.format(d,'yyyy-MM-dd')},
                                key=${dateStr + '_' + hour},
                                status=${week2StatusMap.get(key) != null ? week2StatusMap.get(key) : 0}
                            "
                            th:class="'cell status-' + ${status}"
                            th:data-key="${key}"
                            onclick="toggleCell(this)">
                        </td>
                    </tr>
                    </tbody>
                </table>

            </div>
        </div>

        <button type="submit" class="btn btn-success">
            Availability Kaydet
        </button>
    </form>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    // FINAL STATE
    let selectedSlots = new Set();
    const employeeId = [[${employeeId}]];

    // WHEN THE PAGE LOADS, ADD THE GREEN ONES FROM THE DB TO SET.
    document.querySelectorAll(".cell.status-1").forEach(td => {
        selectedSlots.add(td.dataset.key);
    });

    function showWeek(week) {
        document.getElementById("week1-table").style.display = week === 1 ? "" : "none";
        document.getElementById("week2-table").style.display = week === 2 ? "" : "none";

        document.getElementById("btn-week1").classList.toggle("active", week === 1);
        document.getElementById("btn-week2").classList.toggle("active", week === 2);
    }

    function toggleCell(td) {
        if (td.classList.contains("status-2")) return;

        const key = td.dataset.key;

        if (selectedSlots.has(key)) {
            selectedSlots.delete(key);
            td.classList.remove("status-1");
            td.classList.add("status-0");
        } else {
            selectedSlots.add(key);
            td.classList.remove("status-0");
            td.classList.add("status-1");
        }
    }

    function prepareSubmit() {
        document.getElementById("slotsInput").value =
            Array.from(selectedSlots).join(",");
    }

    // SUBMIT (AJAX)
    function submitAvailability(event) {
        event.preventDefault(); //  NO PAGE RELOAD

        // Filling hidden inputs fow slots that filled already
        document.getElementById("slotsInput").value =
            Array.from(selectedSlots).join(",");

        fetch(`/employees/${employeeId}/availability/submit`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                slots: document.getElementById("slotsInput").value
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(msg => { throw msg; });
                }
                return response.text();
            })
            .then(() => {
                //  SUCCESSFUL → SHOW POPUP
                showSuccessPopup();
            })
            .catch(errorMessage => {
                //  ERROR → REDIRECT SAME PAGE WITHOUT RELOADING
                showAvailabilityError(errorMessage);
            });
    }

    // IF SUCCESS SHOW POP UP
    function showSuccessPopup() {
        const popup = document.getElementById("success-popup");
        popup.style.display = "block";

        setTimeout(() => {
            popup.style.display = "none";
        }, 2000); // 2 soconds for pop up to disappear
    }

    // SHOW ERROR
    function showAvailabilityError(message) {
        const warning = document.getElementById("availability-warning");
        warning.innerText = message;
        warning.style.display = "block";
    }

    /*]]>*/
</script>

</body>
</html>
