<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Availability</title>
    <!-- <link rel="stylesheet" th:href="@{/css/style.css}"> -->
    <style>
        /* ================================
           GLOBAL RESET & BASE
        ================================ */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f4f6f9;
            color: #1f2937;
        }

        /* ================================
           CONTAINER
        ================================ */
        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .availability-container h1 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 16px;
        }

        /* ================================
           ACTION BAR
        ================================ */
        .availability-actions {
            margin-bottom: 20px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        /* BUTTON VARIANTS */
        .btn-secondary {
            background: #e5e7eb;
            color: #1f2937;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-success {
            background: #16a34a;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-small {
            width: 100%;
            padding: 12px 10px;
            font-size: 14px;
            border-radius: 10px;
            background: #e0f2fe;
            color: #0369a1;
        }

        .btn-small:hover {
            background: #bae6fd;
        }

        /* ACTIVE WEEK BUTTON */
        .btn-small.active {
            background: #16a34a;
            color: #ffffff;
        }

        /* ================================
           ALERTS & POPUPS
        ================================ */
        .availability-error-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc2626; /* red */
            color: #ffffff;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 10px 25px rgba(0,0,0,0.18);
            display: none;
            z-index: 1000;
        }

        .availability-success-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #16a34a;
            color: #ffffff;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }

        /* ================================
           LAYOUT
        ================================ */
        .availability-layout {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }

        /* ================================
           SIDEBAR
        ================================ */
        .availability-sidebar {
            width: 140px;
            background: #ffffff;
            padding: 16px;
            border-radius: 14px;
            box-shadow: 0 8px 22px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ================================
           TABLE WRAPPER
        ================================ */
        .availability-table-wrapper {
            flex: 1;
            overflow-x: auto;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 28px rgba(0,0,0,0.08);
            padding: 16px;
        }

        /* ================================
           TABLE
        ================================ */
        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .table thead th {
            background: #f1f5f9;
            padding: 12px;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            border-bottom: 2px solid #e5e7eb;
        }

        .table tbody td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            font-size: 13px;
        }

        /* HOUR COLUMN */
        .table tbody td:first-child {
            background: #f8fafc;
            font-weight: 700;
            width: 100px;
        }

        /* ================================
           AVAILABILITY INFO BOX
        ================================ */
        .availability-info {
            margin-bottom: 18px;
            padding: 14px 18px;
            background: #f8fafc;
            border-left: 5px solid #2563eb;
            border-radius: 10px;
            font-weight: 600;
            color: #1f2937;
            line-height: 1.5;
        }

        .availability-info strong {
            color: #2563eb;
            font-weight: 800;
        }

        /* ================================
           AVAILABILITY CELLS
        ================================ */
        .cell {
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 6px;
        }

        /* NOT AVAILABLE */
        .status-0 {
            background: #f1f5f9;
        }

        .status-0:hover {
            background: #e5e7eb;
        }

        /* AVAILABLE */
        .status-1 {
            background: #22c55e;
        }

        .status-1:hover {
            background: #16a34a;
        }

        /* BLOCKED / JOB ASSIGNED */
        .status-2 {
            background: #e61a0b;
            cursor: not-allowed;
        }

        /* ================================
           SUBMIT BUTTON
        ================================ */
        form > .btn-success {
            margin-top: 24px;
            padding: 14px 26px;
            font-size: 16px;
            border-radius: 12px;
        }

        /* ================================
           RESPONSIVE
        ================================ */
        @media (max-width: 1000px) {
            .availability-layout {
                flex-direction: column;
            }

            .availability-sidebar {
                width: 100%;
                flex-direction: row;
            }

            .btn-small {
                flex: 1;
            }
        }



    </style>
</head>

<body>
<div class="container availability-container">
    <h1>Availability</h1>

    <!-- GO BACK TO DASHBOARD -->
    <div class="availability-actions">
        <a th:href="@{|/employees/${employeeId}/dashboard|}"
           class="btn btn-secondary">
            Geri Dön
        </a>
    </div>

    <!-- ERROR MESSAGE -->
    <div id="error-popup" class="availability-error-popup">
        Hata oluştu
    </div>

    <div id="success-popup" class="availability-success-popup">
        Availability başarıyla kaydedildi. ✔
    </div>


    <form id="availabilityForm" onsubmit="submitAvailability(event)">

        <!-- FINAL SELECTION -->
        <input type="hidden" name="slots" id="slotsInput">

        <div class="availability-info">
            Her hafta için en az
            <strong th:text="${minDay}"></strong> gün
            ve her gün için
            <strong th:text="${minHour}"></strong> saat
            olacak şekilde availability girmeniz gerekmektedir.
        </div>


        <div class="availability-layout">

            <!-- WEEK SELECT -->
            <div class="availability-sidebar">
                <button type="button"
                        id="btn-week1"
                        class="btn btn-small active"
                        onclick="showWeek(1)">
                    1. Hafta
                </button>

                <button type="button"
                        id="btn-week2"
                        class="btn btn-small"
                        onclick="showWeek(2)">
                    2. Hafta
                </button>
            </div>

            <!-- TABLES -->
            <div class="availability-table-wrapper">

                <!-- WEEK 1 -->
                <table id="week1-table" class="table availability-table">
                    <thead>
                    <tr>
                        <th>Saat \ Tarih</th>
                        <th th:each="d : ${week1Dates}"
                            th:text="${#temporals.format(d,'EEE dd.MM')}"></th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="hour : ${hours}">
                        <td th:text="${hour + ':00'}"></td>

                        <td th:each="d : ${week1Dates}"
                            th:with="
                                dateStr=${#temporals.format(d,'yyyy-MM-dd')},
                                key=${dateStr + '_' + hour},
                                status=${week1StatusMap.get(key) != null ? week1StatusMap.get(key) : 0}
                            "
                            th:class="'cell status-' + ${status}"
                            th:data-key="${key}"
                            onclick="toggleCell(this)">
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!-- WEEK 2 -->
                <table id="week2-table" class="table availability-table" style="display:none;">
                    <thead>
                    <tr>
                        <th>Saat \ Tarih</th>
                        <th th:each="d : ${week2Dates}"
                            th:text="${#temporals.format(d,'EEE dd.MM')}"></th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="hour : ${hours}">
                        <td th:text="${hour + ':00'}"></td>

                        <td th:each="d : ${week2Dates}"
                            th:with="
                                dateStr=${#temporals.format(d,'yyyy-MM-dd')},
                                key=${dateStr + '_' + hour},
                                status=${week2StatusMap.get(key) != null ? week2StatusMap.get(key) : 0}
                            "
                            th:class="'cell status-' + ${status}"
                            th:data-key="${key}"
                            onclick="toggleCell(this)">
                        </td>
                    </tr>
                    </tbody>
                </table>

            </div>
        </div>

        <button type="submit"
                id="submitBtn"
                class="btn btn-success"
                th:if="${isSunday}">
            Availability Kaydet
        </button>

        <div th:if="${!isSunday}"
             style="margin-top:24px; font-weight:700; color:#dc2626;">
            Bu tabloyu sadece <strong>Pazar günleri</strong> doldurabilir veya değişiklik yapabilirsiniz.
        </div>
    </form>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    // FINAL STATE
    let selectedSlots = new Set();
    const employeeId = [[${employeeId}]];
    const isSunday = [[${isSunday}]];

    // WHEN THE PAGE LOADS, ADD THE GREEN ONES FROM THE DB TO SET.
    document.querySelectorAll(".cell.status-1").forEach(td => {
        selectedSlots.add(td.dataset.key);
    });

    function showWeek(week) {
        document.getElementById("week1-table").style.display = week === 1 ? "" : "none";
        document.getElementById("week2-table").style.display = week === 2 ? "" : "none";

        document.getElementById("btn-week1").classList.toggle("active", week === 1);
        document.getElementById("btn-week2").classList.toggle("active", week === 2);
    }

    function toggleCell(td) {
        if (td.classList.contains("status-2")) return;

        const key = td.dataset.key;

        if (selectedSlots.has(key)) {
            selectedSlots.delete(key);
            td.classList.remove("status-1");
            td.classList.add("status-0");
        } else {
            selectedSlots.add(key);
            td.classList.remove("status-0");
            td.classList.add("status-1");
        }
    }

    function prepareSubmit() {
        document.getElementById("slotsInput").value =
            Array.from(selectedSlots).join(",");
    }

    // SUBMIT (AJAX)
    function submitAvailability(event) {
        event.preventDefault(); //  NO PAGE RELOAD


        if (!isSunday) {
            showAvailabilityError("Bu tabloyu sadece Pazar günleri doldurabilir veya değişiklik yapabilirsiniz.");
            return;
        }

        // Filling hidden inputs fow slots that filled already
        document.getElementById("slotsInput").value =
            Array.from(selectedSlots).join(",");

        fetch(`/employees/${employeeId}/availability/submit`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                slots: document.getElementById("slotsInput").value
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(msg => { throw msg; });
                }
                return response.text();
            })
            .then(() => {
                //  SUCCESSFUL → SHOW POPUP
                showSuccessPopup();
            })
            .catch(errorMessage => {
                //  ERROR → REDIRECT SAME PAGE WITHOUT RELOADING
                showAvailabilityError(errorMessage);
            });
    }

    // IF SUCCESS SHOW POP UP
    function showSuccessPopup() {
        const popup = document.getElementById("success-popup");
        popup.style.display = "block";

        setTimeout(() => {
            popup.style.display = "none";
        }, 2000); // 2 soconds for pop up to disappear
    }

    // SHOW ERROR
    function showAvailabilityError(message) {
        const popup = document.getElementById("error-popup");
        popup.innerText = message;
        popup.style.display = "block";

        setTimeout(() => {
            popup.style.display = "none";
        }, 3000);
    }

    /*]]>*/
</script>

</body>
</html>
